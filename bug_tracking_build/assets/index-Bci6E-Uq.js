import{r as c,j as e,P as se,h as T,s as te,t as ae,o as re,p as ie,_,B as N,q as I}from"./index-DrflWDVx.js";import{b as le}from"./index.esm-d2sO6N8F.js";import{c as oe,a as de,C as ne,b as ce,d as ue,e as me}from"./index-BycSI833.js";import{S as C,a as M,b as P,c as L,d as l,I as pe}from"./select-CSSTk0hz.js";import{L as A,T as he,D as xe,a as ge}from"./dialog-CDJ-zaX6.js";import{u as je,a as fe,b as ye}from"./useCustomQuery-Nfj3mi_p.js";import{E as H}from"./eye-GRFvoN7a.js";import{X as O}from"./x-qhIxJMg7.js";const ve=oe("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);var be="Label",z=c.forwardRef((a,u)=>e.jsx(se.label,{...a,ref:u,onMouseDown:d=>{var g;d.target.closest("button, input, select, textarea")||((g=a.onMouseDown)==null||g.call(a,d),!d.defaultPrevented&&d.detail>1&&d.preventDefault())}}));z.displayName=be;var W=z;const Ne=te("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),n=c.forwardRef(({className:a,...u},d)=>e.jsx(W,{ref:d,className:T(Ne(),a),...u}));n.displayName=W.displayName;function qe({}){var R,$;const[a,u]=c.useState([]),[d,b]=c.useState([]),[g,f]=c.useState(null),[F]=ae(),k=F.get("id"),r=!!k,y=F.get("module"),[U,D]=c.useState(!1),{register:j,handleSubmit:G,setValue:m,watch:w,reset:B,formState:{errors:i}}=le({defaultValues:{module:""}}),V=re(),{user:h}=ie(),v=(h==null?void 0:h.roleName)||"",J=(h==null?void 0:h._id)||0,X=(h==null?void 0:h.ulbName)||"";c.useEffect(()=>{j("type",{required:"Type is required"}),j("module",{required:"Module is required"}),j("source",{required:"Source is required"}),v==="Developer"&&(j("priority",{required:"Priority is required"}),j("complexity",{required:"Complexity is required"}))},[j,v]);const E=je({}),K=s=>{const t=Array.from(s.target.files||[]),x=t.filter(o=>o.type.startsWith("image/"));if(x.length!==t.length){_.error("Only image files are allowed");return}u(o=>[...o,...x])},Q=s=>{u(t=>t.filter((x,o)=>o!==s))},p=fe({api:`${I.getModules}`,key:"getModule",value:[],options:{enabled:!0}}),{data:S,isLoading:Se}=ye({api:`${I.getBugById}/${k}`,key:`getBug-${k}`,options:{enabled:r}});c.useEffect(()=>{var s;if(!p.isLoading&&((s=p.data)!=null&&s.data)&&!U&&!r){const t=p.data.data;if(y){t.some(q=>q.module_name===y)?(m("module",y),localStorage.setItem("last_selected_module",y)):(_.error(`Module "${y}" not found. Please select a valid module.`),t.length>0&&(m("module",t[0].module_name),localStorage.setItem("last_selected_module",t[0].module_name))),D(!0);return}const x=localStorage.getItem("last_selected_module");x&&t.some(o=>o.module_name===x)?m("module",x):t.length>0&&(m("module",t[0].module_name),localStorage.setItem("last_selected_module",t[0].module_name)),D(!0)}},[p.isLoading,p.data,y,m,r,U]),c.useEffect(()=>{if(S!=null&&S.data&&r){const s=S.data;B({type:s.entry_type==="Bug"?"Bug":"Enhancement",module:s.module_name,title:s.title,description:s.description,source:s.source,priority:s.priority,complexity:s.complexity}),b(s.screenshots||[]),D(!0)}},[S,B,r]);const Y=async s=>{var q;if(a.length>5){_.error("Maximum 5 screenshots allowed");return}const t=new FormData;t.append("type",s.type),t.append("module",s.module),t.append("title",s.title),t.append("description",s.description),t.append("source",s.source),t.append("user_role",v),t.append("user_id",J.toString()),t.append("ulb_name",X),s.priority&&v=="Developer"&&t.append("priority",s.priority),s.complexity&&v=="Developer"&&t.append("complexity",s.complexity),a.forEach(ee=>{t.append("files",ee)}),r&&t.append("bugId",k);const x=r?`${I.updateBug}`:`${I.createBug}`,o=await E.mutateAsync({api:x,data:t});o.status?(_.success(r?"Bug updated successfully!":"Bug reported successfully!"),V("/bug-tracking/dashboard/bug/list"),B(),u([])):_.error(((q=o==null?void 0:o.data)==null?void 0:q.message)||`Failed to ${r?"update":"report"} bug`)},Z=w("module");return e.jsxs(de,{children:[e.jsxs(ne,{children:[e.jsxs(ce,{className:"space-y-1 border-b bg-muted/40",children:[e.jsx(ue,{className:"text-2xl font-semibold",children:r?"Update Bug":"Report New Bug"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r?"Modify the details of the reported bug":"Fill out the form below to report a bug or request an enhancement"})]}),e.jsx(me,{className:"pt-6",children:e.jsxs("form",{onSubmit:G(Y),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"type",children:"Type *"}),e.jsxs(C,{onValueChange:s=>m("type",s,{shouldValidate:!0}),value:w("type"),children:[e.jsx(M,{children:e.jsx(P,{placeholder:"Select type"})}),e.jsxs(L,{children:[e.jsx(l,{value:"Bug",children:"Bug"}),e.jsx(l,{value:"Enhancement",children:"Enhancement"})]})]}),i.type&&e.jsx("p",{className:"text-sm text-red-500",children:i.type.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"module_name",children:"Module *"}),e.jsxs(C,{onValueChange:s=>{m("module",s,{shouldValidate:!0})},value:Z,disabled:p.isLoading,children:[e.jsx(M,{children:p.isLoading?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Loading modules..."})]}):e.jsx(P,{placeholder:"Select module"})}),e.jsx(L,{children:($=(R=p==null?void 0:p.data)==null?void 0:R.data)==null?void 0:$.map(s=>e.jsx(l,{value:s.module_name,children:s.module_name},s.id))})]}),i.module&&e.jsx("p",{className:"text-sm text-red-500",children:i.module.message}),y&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Module pre-selected from source, you can change it if needed."})]}),v==="Developer"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"priority",children:"Priority *"}),e.jsxs(C,{onValueChange:s=>m("priority",s,{shouldValidate:!0}),value:w("priority"),children:[e.jsx(M,{children:e.jsx(P,{placeholder:"Select priority"})}),e.jsxs(L,{children:[e.jsx(l,{value:"Low",children:"Low"}),e.jsx(l,{value:"Medium",children:"Medium"}),e.jsx(l,{value:"High",children:"High"}),e.jsx(l,{value:"Critical",children:"Critical"})]})]}),i.priority&&e.jsx("p",{className:"text-sm text-red-500",children:i.priority.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"source",children:"Source *"}),e.jsxs(C,{onValueChange:s=>m("source",s,{shouldValidate:!0}),value:w("source"),children:[e.jsx(M,{children:e.jsx(P,{placeholder:"Select source"})}),e.jsxs(L,{children:[e.jsx(l,{value:"Web",children:"Web"}),e.jsx(l,{value:"Mobile App",children:"Mobile App"}),e.jsx(l,{value:"API",children:"API"}),e.jsx(l,{value:"Other",children:"Other"})]})]}),i.source&&e.jsx("p",{className:"text-sm text-red-500",children:i.source.message})]}),v==="Developer"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"complexity",children:"Complexity *"}),e.jsxs(C,{onValueChange:s=>m("complexity",s,{shouldValidate:!0}),value:w("complexity"),children:[e.jsx(M,{children:e.jsx(P,{placeholder:"Select complexity"})}),e.jsxs(L,{children:[e.jsx(l,{value:"Low",children:"Low"}),e.jsx(l,{value:"Medium",children:"Medium"}),e.jsx(l,{value:"High",children:"High"})]})]}),i.complexity&&e.jsx("p",{className:"text-sm text-red-500",children:i.complexity.message})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"title",children:"Title *"}),e.jsx(pe,{id:"title",placeholder:"Enter a descriptive title for the bug",...j("title",{required:"Title is required"})}),i.title&&e.jsx("p",{className:"text-sm text-red-500",children:i.title.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"description",children:"Description *"}),e.jsx(he,{id:"description",rows:4,placeholder:"Provide detailed description of the bug or enhancement request",...j("description",{required:"Description is required"})}),i.description&&e.jsx("p",{className:"text-sm text-red-500",children:i.description.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"Screenshots"}),e.jsxs("div",{className:"rounded-lg border-2 border-dashed  text-center",children:[e.jsxs("label",{htmlFor:"screenshots",className:"cursor-pointer ",children:[e.jsx(ve,{className:"mx-auto h-12 w-12 text-muted-foreground mt-4"}),e.jsxs("span",{className:"block text-sm font-medium p-2",children:["Upload screenshots",e.jsx("p",{className:"text-xs text-muted-foreground",children:"PNG, JPG up to 5MB"})]})]}),e.jsx("input",{id:"screenshots",type:"file",multiple:!0,accept:"image/*",className:"hidden p-6",onChange:K})]}),r&&e.jsx("p",{className:"text-xs font-semibold text-muted-foreground mt-1",children:"Note: Any new screenshots uploaded will be added to the existing collection."})]}),r&&d.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(n,{className:"text-muted-foreground",children:"Existing Screenshots"}),e.jsx("div",{className:"grid grid-cols-2 gap-4 md:grid-cols-4 lg:grid-cols-5",children:d.map((s,t)=>e.jsxs("div",{className:"group relative aspect-video overflow-hidden rounded-xl border-2 border-muted bg-muted shadow-sm transition-all hover:border-indigo-300 hover:shadow-md",children:[e.jsx("img",{src:s,alt:`Existing ${t}`,className:"h-full w-full object-cover"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 backdrop-blur-[2px] transition-all duration-300 group-hover:opacity-100",children:e.jsx(N,{type:"button",size:"icon",variant:"secondary",className:"h-9 w-9 rounded-full shadow-lg transition-transform hover:scale-110",onClick:()=>f(s),children:e.jsx(H,{className:"h-4 w-4 text-indigo-600"})})})]},`existing-${t}`))})]}),e.jsxs("div",{className:"space-y-3",children:[a.length>0&&e.jsx(n,{className:"text-muted-foreground",children:"New Screenshots to Upload"}),a.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-4 md:grid-cols-4 lg:grid-cols-5",children:a.map((s,t)=>e.jsx(we,{file:s,onPreview:f,onRemove:()=>Q(t)},`${s.name}-${t}`))})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(N,{type:"button",variant:"outline",onClick:()=>{r?V("/bug-tracking/dashboard/bug/list"):(B(),u([]))},children:r?"Cancel":"Reset"}),e.jsx(N,{type:"submit",disabled:E.isPending,className:T("min-w-[160px] rounded-full transition-all duration-300",E.isPending?"bg-indigo-400 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700 "),children:E.isPending?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:r?"Updating...":"Submitting..."})]}):e.jsx("div",{className:"flex items-center justify-center gap-2",children:r?"Update Bug Report":"Submit Bug Report"})})]})]})})]}),e.jsx(xe,{open:!!g,onOpenChange:s=>{s||f(null)},children:e.jsx(ge,{className:"max-w-3xl overflow-hidden rounded-2xl border-none p-0 bg-transparent shadow-none",children:g&&e.jsxs("div",{className:"relative group animate-in zoom-in duration-300",children:[e.jsx("img",{src:g,alt:"Screenshot preview",className:"h-auto max-h-[85vh] w-full rounded-2xl object-contain shadow-2xl"}),e.jsx(N,{variant:"destructive",size:"icon",className:"absolute top-4 right-4 h-10 w-10 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300",onClick:()=>f(null),children:e.jsx(O,{className:"h-5 w-5"})})]})})})]})}function we({file:a,onPreview:u,onRemove:d}){const[b,g]=c.useState("");return c.useEffect(()=>{const f=URL.createObjectURL(a);return g(f),()=>URL.revokeObjectURL(f)},[a]),e.jsxs("div",{className:"group relative aspect-video overflow-hidden rounded-xl border-2 border-muted bg-muted shadow-sm transition-all hover:border-indigo-300 hover:shadow-md",children:[b&&e.jsx("img",{src:b,alt:a.name,className:"h-full w-full object-cover"}),e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center gap-2 bg-black/40 opacity-0 backdrop-blur-[2px] transition-all duration-300 group-hover:opacity-100",children:[e.jsx(N,{type:"button",size:"icon",variant:"secondary",className:"h-9 w-9 rounded-full shadow-lg transition-transform hover:scale-110",onClick:()=>u(b),children:e.jsx(H,{className:"h-4 w-4 text-indigo-600"})}),e.jsx(N,{type:"button",size:"icon",variant:"destructive",className:"h-9 w-9 rounded-full shadow-lg transition-transform hover:scale-110",onClick:d,children:e.jsx(O,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/50 px-2 py-1 opacity-0 transition-opacity group-hover:opacity-100",children:e.jsx("p",{className:"truncate text-[10px] font-medium text-white",children:a.name})})]})}export{qe as default};
