import{r as p,j as e,P as de,h as G,s as ne,t as ce,o as ue,p as me,_ as k,B as L,q as B}from"./index-ClWu5hcI.js";import{b as pe}from"./index.esm-DpIGpe-q.js";import{c as he,a as xe,C as ge,b as je,d as fe,e as ye}from"./index-Bq7iKb49.js";import{S as _,a as E,b as C,c as T,d as o,I as ve}from"./select-DZlsU8Fz.js";import{L as z,T as be}from"./textarea-C49U-D8G.js";import{D as Ne,a as we}from"./dialog-OTjkjdxo.js";import{u as Se,a as W,b as _e}from"./useCustomQuery-LkxvGJM3.js";import{E as J}from"./eye-C0edNZYs.js";import{X}from"./x-BPPidrFu.js";const Ee=he("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);var Ce="Label",K=p.forwardRef((a,h)=>e.jsx(de.label,{...a,ref:h,onMouseDown:n=>{var j;n.target.closest("button, input, select, textarea")||((j=a.onMouseDown)==null||j.call(a,n),!n.defaultPrevented&&n.detail>1&&n.preventDefault())}}));K.displayName=Ce;var Q=K;const Te=ne("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),m=p.forwardRef(({className:a,...h},n)=>e.jsx(Q,{ref:n,className:G(Te(),a),...h}));m.displayName=Q.displayName;function Ve({}){var $,A,H,O;const[a,h]=p.useState([]),[n,b]=p.useState([]),[j,y]=p.useState(null),[N,Y]=p.useState(null),[F]=ce(),R=F.get("id"),i=!!R,v=F.get("module"),[U,I]=p.useState(!1),{register:f,handleSubmit:Z,setValue:x,watch:M,reset:q,formState:{errors:d}}=pe({defaultValues:{module:""}}),V=ue(),{user:c}=me(),l=(c==null?void 0:c.roleName)||"",ee=(c==null?void 0:c._id)||0,se=(c==null?void 0:c.ulbName)||"",te=(c==null?void 0:c.ulbId)||"";p.useEffect(()=>{f("type",{required:"Type is required"}),f("module",{required:"Module is required"}),f("source",{required:"Source is required"}),(l==="Developer"||l==="TESTER")&&(f("priority",{required:"Priority is required"}),f("complexity",{required:"Complexity is required"}))},[f,l]);const D=Se({}),ae=s=>{const t=Array.from(s.target.files||[]),u=t.filter(r=>r.type.startsWith("image/"));if(u.length!==t.length){k.error("Only image files are allowed");return}h(r=>[...r,...u])},ie=s=>{h(t=>t.filter((u,r)=>r!==s))},g=W({api:`${B.getModules}`,key:"getModule",value:[],options:{enabled:!0}}),w=W({api:`${B.getUlbs}`,key:"getUlbs",value:[],options:{enabled:!0}}),{data:P,isLoading:Me}=_e({api:`${B.getBugById}/${R}`,key:`getBug-${R}`,options:{enabled:i}});p.useEffect(()=>{var s;if(!g.isLoading&&((s=g.data)!=null&&s.data)&&!U&&!i){const t=g.data.data;if(v){t.some(S=>S.module_name===v)?(x("module",v),localStorage.setItem("last_selected_module",v)):(k.error(`Module "${v}" not found. Please select a valid module.`),t.length>0&&(x("module",t[0].module_name),localStorage.setItem("last_selected_module",t[0].module_name))),I(!0);return}const u=localStorage.getItem("last_selected_module");u&&t.some(r=>r.module_name===u)?x("module",u):t.length>0&&(x("module",t[0].module_name),localStorage.setItem("last_selected_module",t[0].module_name)),I(!0)}},[g.isLoading,g.data,v,x,i,U]),p.useEffect(()=>{if(P!=null&&P.data&&i){const s=P.data;q({type:s.entry_type==="Bug"?"Bug":"Enhancement",module:s.module_name,title:s.title,description:s.description,source:s.source,priority:s.priority,complexity:s.complexity}),b(s.screenshots||[]),I(!0)}},[P,q,i]);const le=async s=>{var S;if(a.length>5){k.error("Maximum 5 screenshots allowed");return}const t=new FormData;t.append("type",s.type),t.append("module",s.module),t.append("title",s.title),t.append("description",s.description),t.append("source",s.source),t.append("user_role",l),t.append("user_id",ee.toString()),l!=="Developer"&&l!=="TESTER"?(t.append("ulb_name",se),t.append("ulb_id",te.toString())):N&&(t.append("ulb_name",N.name),t.append("ulb_id",N.id)),s.priority&&(l==="Developer"||l==="TESTER")&&t.append("priority",s.priority),s.complexity&&(l==="Developer"||l==="TESTER")&&t.append("complexity",s.complexity),a.forEach(oe=>{t.append("files",oe)}),i&&t.append("bugId",R);const u=i?`${B.updateBug}`:`${B.createBug}`,r=await D.mutateAsync({api:u,data:t});r.status?(k.success(i?"Bug updated successfully!":"Bug reported successfully!"),V("/bug-tracking/dashboard/bug/list"),q(),h([])):k.error(((S=r==null?void 0:r.data)==null?void 0:S.message)||`Failed to ${i?"update":"report"} bug`)},re=M("module");return e.jsxs(xe,{children:[e.jsxs(ge,{children:[e.jsxs(je,{className:"space-y-1 border-b bg-muted/40",children:[e.jsx(fe,{className:"text-2xl font-semibold",children:i?"Update Bug":"Report New Bug"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i?"Modify the details of the reported bug":"Fill out the form below to report a bug or request an enhancement"})]}),e.jsx(ye,{className:"pt-6",children:e.jsxs("form",{onSubmit:Z(le),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"type",children:"Type *"}),e.jsxs(_,{onValueChange:s=>x("type",s,{shouldValidate:!0}),value:M("type"),children:[e.jsx(E,{children:e.jsx(C,{placeholder:"Select type"})}),e.jsxs(T,{children:[e.jsx(o,{value:"Bug",children:"Bug"}),e.jsx(o,{value:"Enhancement",children:"Enhancement"})]})]}),d.type&&e.jsx("p",{className:"text-sm text-red-500",children:d.type.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"module_name",children:"Module *"}),e.jsxs(_,{onValueChange:s=>{x("module",s,{shouldValidate:!0})},value:re,disabled:g.isLoading,children:[e.jsx(E,{children:g.isLoading?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Loading modules..."})]}):e.jsx(C,{placeholder:"Select module"})}),e.jsx(T,{children:(A=($=g==null?void 0:g.data)==null?void 0:$.data)==null?void 0:A.map(s=>e.jsx(o,{value:s.module_name,children:s.module_name},s.id))})]}),d.module&&e.jsx("p",{className:"text-sm text-red-500",children:d.module.message}),v&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Module pre-selected from source, you can change it if needed."})]}),(l==="Developer"||l==="TESTER")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"priority",children:"Priority *"}),e.jsxs(_,{onValueChange:s=>x("priority",s,{shouldValidate:!0}),value:M("priority"),children:[e.jsx(E,{children:e.jsx(C,{placeholder:"Select priority"})}),e.jsxs(T,{children:[e.jsx(o,{value:"Low",children:"Low"}),e.jsx(o,{value:"Medium",children:"Medium"}),e.jsx(o,{value:"High",children:"High"}),e.jsx(o,{value:"Critical",children:"Critical"})]})]}),d.priority&&e.jsx("p",{className:"text-sm text-red-500",children:d.priority.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"source",children:"Source *"}),e.jsxs(_,{onValueChange:s=>x("source",s,{shouldValidate:!0}),value:M("source"),children:[e.jsx(E,{children:e.jsx(C,{placeholder:"Select source"})}),e.jsxs(T,{children:[e.jsx(o,{value:"Web",children:"Web"}),e.jsx(o,{value:"Mobile App",children:"Mobile App"}),e.jsx(o,{value:"API",children:"API"}),e.jsx(o,{value:"Other",children:"Other"})]})]}),d.source&&e.jsx("p",{className:"text-sm text-red-500",children:d.source.message})]}),(l==="Developer"||l==="TESTER")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"complexity",children:"Complexity *"}),e.jsxs(_,{onValueChange:s=>x("complexity",s,{shouldValidate:!0}),value:M("complexity"),children:[e.jsx(E,{children:e.jsx(C,{placeholder:"Select complexity"})}),e.jsxs(T,{children:[e.jsx(o,{value:"Low",children:"Low"}),e.jsx(o,{value:"Medium",children:"Medium"}),e.jsx(o,{value:"High",children:"High"})]})]}),d.complexity&&e.jsx("p",{className:"text-sm text-red-500",children:d.complexity.message})]}),(l==="Developer"||l==="TESTER")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"ulb_name",children:"Ulb Name *"}),e.jsxs(_,{onValueChange:s=>{var u,r;const t=(r=(u=w==null?void 0:w.data)==null?void 0:u.data)==null?void 0:r.find(S=>S.id.toString()===s);t&&Y({id:t.id.toString(),name:t.ulb_name})},value:N==null?void 0:N.id,children:[e.jsx(E,{children:e.jsx(C,{placeholder:"Select ULB"})}),e.jsx(T,{children:(O=(H=w==null?void 0:w.data)==null?void 0:H.data)==null?void 0:O.map(s=>e.jsx(o,{value:s.id.toString(),children:s.ulb_name},s.id))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"title",children:"Title *"}),e.jsx(ve,{id:"title",placeholder:"Enter a descriptive title for the bug",...f("title",{required:"Title is required"})}),d.title&&e.jsx("p",{className:"text-sm text-red-500",children:d.title.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"description",children:"Description *"}),e.jsx(be,{id:"description",rows:8,placeholder:"Provide detailed description of the bug or enhancement request",...f("description",{required:"Description is required"})}),d.description&&e.jsx("p",{className:"text-sm text-red-500",children:d.description.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Screenshots"}),e.jsxs("div",{className:"rounded-lg border-2 border-dashed  text-center",children:[e.jsxs("label",{htmlFor:"screenshots",className:"cursor-pointer ",children:[e.jsx(Ee,{className:"mx-auto mt-4 h-12 w-12 text-muted-foreground"}),e.jsxs("span",{className:"block p-2 text-sm font-medium",children:["Upload screenshots",e.jsx("p",{className:"text-xs text-muted-foreground",children:"PNG, JPG up to 5MB"})]})]}),e.jsx("input",{id:"screenshots",type:"file",multiple:!0,accept:"image/*",className:"hidden p-6",onChange:ae})]}),i&&e.jsx("p",{className:"mt-1 text-xs font-semibold text-muted-foreground",children:"Note: Any new screenshots uploaded will be added to the existing collection."})]}),i&&n.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{className:"text-muted-foreground",children:"Existing Screenshots"}),e.jsx("div",{className:"grid grid-cols-2 gap-4 md:grid-cols-4 lg:grid-cols-5",children:n.map((s,t)=>e.jsxs("div",{className:"group relative aspect-video overflow-hidden rounded-xl border-2 border-muted bg-muted shadow-sm transition-all hover:border-indigo-300 hover:shadow-md",children:[e.jsx("img",{src:s,alt:`Existing ${t}`,className:"h-full w-full object-cover"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 backdrop-blur-[2px] transition-all duration-300 group-hover:opacity-100",children:e.jsx(L,{type:"button",size:"icon",variant:"secondary",className:"h-9 w-9 rounded-full shadow-lg transition-transform hover:scale-110",onClick:()=>y(s),children:e.jsx(J,{className:"h-4 w-4 text-indigo-600"})})})]},`existing-${t}`))})]}),e.jsxs("div",{className:"space-y-3",children:[a.length>0&&e.jsx(m,{className:"text-muted-foreground",children:"New Screenshots to Upload"}),a.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-4 md:grid-cols-4 lg:grid-cols-5",children:a.map((s,t)=>e.jsx(Le,{file:s,onPreview:y,onRemove:()=>ie(t)},`${s.name}-${t}`))})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(L,{type:"button",variant:"outline",onClick:()=>{i?V("/bug-tracking/dashboard/bug/list"):(q(),h([]))},children:i?"Cancel":"Reset"}),e.jsx(L,{type:"submit",disabled:D.isPending,className:G("min-w-[160px] rounded-full transition-all duration-300",D.isPending?"cursor-not-allowed bg-indigo-400":"bg-indigo-600 hover:bg-indigo-700 "),children:D.isPending?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:i?"Updating...":"Submitting..."})]}):e.jsx("div",{className:"flex items-center justify-center gap-2",children:i?"Update Bug Report":"Submit Bug Report"})})]})]})})]}),e.jsx(Ne,{open:!!j,onOpenChange:s=>{s||y(null)},children:e.jsx(we,{className:"max-w-3xl overflow-hidden rounded-2xl border-none bg-transparent p-0 shadow-none",children:j&&e.jsxs("div",{className:"group relative duration-300 animate-in zoom-in",children:[e.jsx("img",{src:j,alt:"Screenshot preview",className:"h-auto max-h-[85vh] w-full rounded-2xl object-contain shadow-2xl"}),e.jsx(L,{variant:"destructive",size:"icon",className:"absolute right-4 top-4 h-10 w-10 rounded-full opacity-0 shadow-lg transition-opacity duration-300 group-hover:opacity-100",onClick:()=>y(null),children:e.jsx(X,{className:"h-5 w-5"})})]})})})]})}function Le({file:a,onPreview:h,onRemove:n}){const[b,j]=p.useState("");return p.useEffect(()=>{const y=URL.createObjectURL(a);return j(y),()=>URL.revokeObjectURL(y)},[a]),e.jsxs("div",{className:"group relative aspect-video overflow-hidden rounded-xl border-2 border-muted bg-muted shadow-sm transition-all hover:border-indigo-300 hover:shadow-md",children:[b&&e.jsx("img",{src:b,alt:a.name,className:"h-full w-full object-cover"}),e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center gap-2 bg-black/40 opacity-0 backdrop-blur-[2px] transition-all duration-300 group-hover:opacity-100",children:[e.jsx(L,{type:"button",size:"icon",variant:"secondary",className:"h-9 w-9 rounded-full shadow-lg transition-transform hover:scale-110",onClick:()=>h(b),children:e.jsx(J,{className:"h-4 w-4 text-indigo-600"})}),e.jsx(L,{type:"button",size:"icon",variant:"destructive",className:"h-9 w-9 rounded-full shadow-lg transition-transform hover:scale-110",onClick:n,children:e.jsx(X,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/50 px-2 py-1 opacity-0 transition-opacity group-hover:opacity-100",children:e.jsx("p",{className:"truncate text-[10px] font-medium text-white",children:a.name})})]})}export{Ve as default};
